# Claude Orchestrator 要件定義書

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Claude Orchestrator |
| コンセプト | AI開発部隊の指揮所（Command Center） |
| ターゲットOS | Windows（ポータブル形式：インストール不要） |
| 技術基盤 | Electron + React（スクラッチ開発） |

### ビジョン
ユーザーが「総監督」となり、PM役のAIと作業員役のAI（Worker）を指揮して開発を行う統合環境。
思考から実装までのタイムラグをゼロにし、マルチモニターを駆使した没入感のある開発体験を提供する。

---

## 2. システムアーキテクチャ

### 3層エージェント構造

```
┌─────────────────────────────────────────────────────┐
│                    User (総監督)                     │
│              自然言語で抽象的な指示                   │
└─────────────────────┬───────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────┐
│                PM Agent (Manager)                    │
│   ・常駐するメインのClaude Code                       │
│   ・タスク分解、Worker召喚・命令指示                  │
└─────────────────────┬───────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────┐
│              Worker Agents (Developers)              │
│   ・動的に生成・破棄されるClaude Code                 │
│   ・特定タスク（実装、テスト、修正）を並列実行        │
└─────────────────────────────────────────────────────┘
```

### 通信方式
- **CLI連携**: node-pty 経由でシェル起動、Claude Code CLI を stdin/stdout で制御
- **制御タグ**: PM → Worker への指示は XML タグ形式（`<dispatch>`, `<spawn_worker>` 等）

---

## 3. 機能要件

### 3.1 画面・ウィンドウ管理（UI/UX）

| 機能 | 説明 | Phase |
|------|------|-------|
| 基本レイアウト | 左: ファイルエクスプローラー＆エディタ、右: AIエージェント領域 | 1 |
| マルチウィンドウ・デタッチ | パネルを別ウィンドウとして独立（マルチモニター対応） | 4 |
| レイアウトテンプレート | ウィンドウ配置の保存・復元 | 4 |
| ダークモードUI | SFチックな「コックピット」デザイン | 1 |

### 3.2 オペレーション・自動化

| 機能 | 説明 | Phase |
|------|------|-------|
| 自動セットアップ | 前回プロジェクト復元、claude コマンド自動起動 | 2 |
| Router機能 | PM出力のXMLタグ解析 → Worker自動転送 | 3 |
| Status Monitor | Worker完了/エラー検知 → PMフィードバック | 3 |
| GUIコマンドパレット | /cost, /compact 等をボタン化 | 2 |

### 3.3 コンテキスト・記憶管理 ★重要

| 機能 | 説明 | Phase |
|------|------|-------|
| Memory Rollover | 会話自動要約 → メモリ解放 → 要約再注入 | 4 |
| Rulebook Injection | プロジェクトルール（MD/PDF）をWorker起動時に自動読込 | 3 |

### 3.4 安全性・制御 ★重要

| 機能 | 説明 | Phase |
|------|------|-------|
| コスト監視カウンター | 全エージェントのトークン使用量をリアルタイム表示 | 4 |
| 緊急停止ボタン | 全Claude Codeプロセス一括終了 | 2 |
| コンフリクト防止 | 同一ファイル編集時の警告ロック | 3 |

### 3.5 フィードバック演出

| 機能 | 説明 | Phase |
|------|------|-------|
| サウンドエフェクト | Worker起動/完了/エラー時にSE再生 | 4 |

### 3.6 ログ・履歴管理 ★追加

| 機能 | 説明 | Phase |
|------|------|-------|
| アプリログ | 動作ログをlogs/app/に日付別保存（DEBUG/INFO/ERROR） | 1 |
| 会話履歴保存 | Claude との全会話をlogs/conversations/に保存 | 2 |
| プロジェクト別管理 | 会話履歴をプロジェクトごとにフォルダ分け | 2 |
| 日付別ファイル | YYYY-MM-DD.md 形式で日別にログ分割 | 2 |

---

## 4. 非機能要件

| 項目 | 要件 |
|------|------|
| パフォーマンス | 4ターミナル＋エディタ同時動作でもカクつかない |
| パッケージング | electron-builder でポータブル形式、アイコン付き（インストール不要） |
| ローカル連携 | ファイルシステムへの完全な読み書き権限 |

---

## 5. 内部プロンプト設計

### PM Agent用 システムプロンプト
```
あなたはプロジェクトマネージャーです。直接コードは書かず、以下のXMLタグでアプリを操作してください。
- <spawn_worker id="名前" role="役割" /> : 新しい作業員ターミナルを起動
- <dispatch target="名前">コマンド</dispatch> : 作業員に指示を送信
- <wait target="名前" /> : 作業員の完了を待機
```

### Worker Agent用 システムプロンプト
```
あなたは実作業担当のWorkerです。
- 指定されたタスクのみを実行してください。
- 作業完了時は必ず <status>COMPLETED</status> と出力してください。
- プロジェクトのルールブック: {Rulebook_Content}
```

---

## 6. 技術スタック

| カテゴリ | 技術 |
|----------|------|
| Framework | Electron (Main/Renderer Process) |
| UI | React, Tailwind CSS |
| State | Zustand |
| Editor | @monaco-editor/react |
| Terminal | xterm.js, node-pty |
| Build | electron-builder |

---

## 7. 開発ロードマップ

### Phase 1: プロトタイプ（MVP）
- 左エディタ、右ターミナル（1つ）の基本構成
- ボタンでコマンド実行
- ポータブルビルド成功

### Phase 2: マルチエージェント実装
- ターミナル動的追加
- PM-Worker手動連携
- 緊急停止ボタン

### Phase 3: オーケストレーション
- XML解析・自動転送
- 3層構造完全稼働
- Rulebook Injection
- コンフリクト防止

### Phase 4: DX向上
- マルチウィンドウ（デタッチ）
- Memory Rollover
- コスト監視
- サウンドエフェクト

---

## 8. ディレクトリ構造

```
Claude-Orchestrator/
├── package.json
├── electron/
│   ├── main.ts          # Electron メインプロセス
│   └── preload.ts       # プリロードスクリプト
├── src/
│   ├── App.tsx          # メインコンポーネント
│   ├── components/
│   │   ├── Editor/      # Monaco Editor
│   │   ├── Terminal/    # xterm.js
│   │   ├── FileExplorer/# カスタムファイルエクスプローラー
│   │   └── Layout/      # パネルレイアウト
│   └── stores/          # Zustand ストア
├── config/              # 設定ファイル保存（ポータブル）
│   └── settings.json
├── logs/                # ログ保存
│   ├── app/            # アプリ動作ログ（日付別）
│   └── conversations/  # 会話履歴（プロジェクト別・日付別）
├── docs/
│   └── REQUIREMENTS.md  # 要件定義書
└── electron-builder.yml # ビルド設定
```
